# GAS E-commerce Stock Logger

対象者：管理や通知機能が無い通販サイトの在庫数を管理したい販売者（出品者）

Google Apps Script (GAS) を活用し、任意のECサイト（通販サイト）の在庫数を定期的に監視し、Googleスプレッドシート上で管理・ログ保存を行うスクリプトです。

**本スクリプトはテンプレートです** デフォルトでは私が販売しているサイトを例として実装されていますが、スクレイピングロジックを変更することで、Shopifyベースのサイトやその他通販サイトへ容易に応用可能です。

**注意点** 過度なスクレイピングは通販サイト側の負荷になります。末尾にある通り規約を確認して運用して下さい。

## ✨ 主な機能

* **商品リスト自動生成**: 販売品一覧ページを巡回し、全商品のURLと名前を自動取得します（新商品も自動追加）。
* **在庫モニタリング**: 定期的に在庫数を取得し、スプレッドシートを更新します。
* **アラート通知**: 設定した在庫数（注意/警告）を下回った際、管理者へメールで通知します（重複通知防止機能付き）。
* **販売数の月次集計**: 在庫の減少分を検知し、月ごとの販売数として集計します。
* **日次ログ**: 1日ごとの在庫推移を自動で記録します。（未検証機能）
* **年度別管理**: 年が変わると自動的に新しいシート（タブ）を作成します。
* **視覚的UI**: 在庫状況に応じた色分けや、列幅の自動最適化を行います。

## 🚀 セットアップ手順

1.  **Googleスプレッドシートの作成**
    * 新規スプレッドシートを作成します。
    * シート名などはスクリプトが自動生成するため、そのままで構いません。

2.  **スクリプトの導入**
    * スプレッドシートのメニューから `拡張機能` > `Apps Script` を開きます。
    * エディタにあるコードを全て削除し、本リポジトリの `code.js` (または `main.js`) の内容をコピペします。

3.  **設定の変更**
    * コード上部の `CONFIG` エリアを編集します。
    ```javascript
    const CONFIG = {
      TARGET_COLLECTION_URL: '[https://example.com/collections/all](https://example.com/collections/all)', // 監視したい販売品の一覧ページのURL
      DOMAIN: '[https://example.com](https://example.com)', // サイトのドメイン
      NOTIFY_EMAIL: 'your-email@example.com', // 通知先メールアドレス
      // ...その他閾値設定
    };
    ```

4.  **初回実行と権限承認**
    * 関数 `updateInventoryAutomatic` を選択し、「実行」ボタンを押します。
    * 初回のみGoogleの権限承認（URLアクセス、メール送信、シート操作）が必要です。

5.  **トリガー設定（自動化）**
    * Apps Script画面左側の時計アイコン（トリガー）をクリックします。
    * 「トリガーを追加」から以下のように設定します。
        * 実行する関数: `updateInventoryAutomatic`
        * イベントのソース: `時間主導型`
        * タイプ: `時間ベースのタイマー`
        * 間隔: `1時間おき`（推奨）

## 🛠 カスタマイズ方法（他サイトへの対応）

このスクリプトを他のサイトで利用する場合、以下の関数内の**正規表現（Regex）**や**DOM探索ロジック**を対象サイトのHTML構造に合わせて変更してください。

### 1. 商品URLの取得ロジック
`getAllProductUrls(startUrl)` 関数を修正します。
現在は `href` に `/products/` を含むリンクを探す仕様になっています。

```javascript
// 例: 商品リンクのパターンを変更する場合
const regex = /<a\s+[^>]*href=["']([^"']*\/item\/[^"']+)["'][^>]*>/g;

### 2. 在庫数の抽出ロジック
`extractStockCount(html)` 関数を修正します。
現在は「在庫数: XX」や「在庫：XX」というテキスト表記を探す仕様になっています。

```javascript
// 例: 特定のクラス名の中身を取得する場合
// <span class="stock-qty">5</span>
const match = html.match(/class="stock-qty">(\d+)</);

### 3. ページネーション（次ページ）の取得
`getAllProductUrls` 内の `nextMatch` 部分を、対象サイトの「次へ」ボタンのHTML構造に合わせて修正してください。

## ⚠️ 免責事項・注意点

* **スクレイピングのルール**: 対象サイトの利用規約および `robots.txt` を必ず確認してください。
* **サーバー負荷への配慮**: スクリプト内には `Utilities.sleep(1000)` 等の待機時間を設けていますが、実行頻度を過剰に高く設定しないでください（推奨：半日に1回）。
* **免責事項**: 本スクリプトの使用によって生じた、対象サイトからのアクセスブロックやその他のトラブルについて、開発者は一切の責任を負いません。自己責任でご利用ください。
